<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .feed-item, .comment, #chat-modal { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .like-btn-liked svg { fill: #ef4444; color: #ef4444; }
        #friends-list-nav { transition: max-height 0.3s ease-in-out; max-height: 0; overflow: hidden; }
        #friends-list-nav.expanded { max-height: 500px; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #fb923c; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-orange-50">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4"><div class="flex justify-between items-center py-3">
            <a href="#" class="text-2xl font-bold text-orange-600">SocialWeb</a>
            <div class="relative">
                <button id="profile-menu-btn" class="w-10 h-10 rounded-full overflow-hidden border-2 border-transparent hover:border-orange-500">
                    <img id="user-avatar" src="https://i.pravatar.cc/40?u=user" alt="Avatar">
                </button>
                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl py-1 z-50">
                    <div class="px-4 py-2"><p class="text-sm font-semibold">Logado como</p><p id="user-email-display" class="text-xs text-gray-500 truncate"></p></div><hr>
                    <a href="./profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Meu Perfil</a>
                    <button id="logout-btn" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 font-semibold">Sair</button>
                </div>
            </div>
        </div></div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Coluna Esquerda: Navegação -->
        <aside class="hidden lg:block lg:col-span-1">
            <div class="bg-white p-4 rounded-lg shadow-md sticky top-24">
                <h3 class="font-bold text-gray-800 mb-4">Navegação</h3>
                <nav class="space-y-1">
                    <a href="./dashboard.html" class="flex items-center space-x-3 p-2 rounded-lg bg-orange-100 text-orange-700 font-semibold">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                        <span>Feed</span>
                    </a>
                    <div id="friends-section">
                        <button id="friends-toggle-btn" class="flex items-center justify-between w-full p-2 rounded-lg text-gray-600 hover:bg-gray-100">
                            <span class="flex items-center space-x-3"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197"></path></svg><span>Amigos</span></span>
                            <span id="friend-count" class="text-xs bg-gray-200 text-gray-700 font-bold px-2 py-1 rounded-full">0</span>
                        </button>
                        <ul id="friends-list-nav" class="mt-2 ml-4 pl-4 border-l-2 border-gray-200"></ul>
                    </div>
                    <a href="./eventos.html" class="flex items-center space-x-3 p-2 rounded-lg text-gray-600 hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span>Eventos</span>
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Coluna Central: Feed -->
        <div class="lg:col-span-3">
            <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                <form id="create-post-form">
                    <textarea id="post-content" class="w-full p-2 border-b focus:outline-none" rows="3" placeholder="O que você está pensando?"></textarea>
                    <div id="image-preview-container" class="hidden mt-4 relative w-32">
                        <img id="image-preview" src="" alt="Preview" class="rounded-lg w-full h-auto">
                        <button id="remove-image-btn" type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6">&times;</button>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <button id="add-image-btn" type="button" class="text-orange-500 hover:text-orange-600 p-2 rounded-full">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                        <div class="flex items-center space-x-2">
                            <button id="gemini-idea-btn" type="button" class="bg-yellow-400 text-yellow-900 px-4 py-2 rounded-lg font-semibold hover:bg-yellow-500 transition-colors flex items-center space-x-2">
                                <span class="gemini-button-text">✨ Gerar Ideia</span>
                            </button>
                            <button id="post-submit-btn" type="submit" class="bg-orange-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-orange-600 disabled:bg-orange-300">Postar</button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="feed-container" class="space-y-6"></div>
        </div>
    </main>
    
    <!-- Modal de Chat Unificado e Botão Flutuante -->
    <div id="chat-modal" class="hidden fixed bottom-24 right-8 bg-white w-80 rounded-xl shadow-2xl flex flex-col pointer-events-auto z-50" style="height: 450px;">
        <div id="user-list-view">
            <header class="bg-gray-800 text-white p-3 rounded-t-xl flex justify-between items-center"><h3 class="font-bold">Usuários</h3><button id="close-user-list-btn" class="text-white hover:text-gray-300 text-2xl leading-none">&times;</button></header>
            <div class="p-2 border-b"><input type="text" id="search-user-input" placeholder="Buscar usuário..." class="w-full p-2 border border-gray-300 rounded-lg"></div>
            <ul id="users-list" class="flex-1 space-y-1 p-2 overflow-y-auto" style="height: calc(100% - 100px);"></ul>
        </div>
        <div id="conversation-view" class="hidden h-full w-full flex flex-col">
            <header class="bg-orange-600 text-white p-3 rounded-t-xl flex justify-between items-center"><div class="flex items-center min-w-0"><button id="back-to-users-btn" class="mr-2 p-1 rounded-full hover:bg-orange-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg></button><img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full mr-2"><h4 id="chat-header-name" class="font-semibold truncate"></h4></div><button id="close-conversation-btn" class="text-white hover:text-gray-300 text-2xl leading-none">&times;</button></header>
            <div id="messages-area" class="flex-1 p-3 overflow-y-auto space-y-2"></div>
            <form id="chat-form" class="p-2 border-t"><input type="text" id="chat-input" class="w-full p-2 border rounded-lg" placeholder="Digite sua mensagem..."></form>
        </div>
    </div>
    <button id="floating-chat-btn" class="fixed bottom-6 right-6 bg-orange-500 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-orange-600 z-50">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
    </button>
    
    <!-- Modais de Post -->
    <div id="edit-post-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg"><h3 class="text-xl font-bold mb-4">Editar Post</h3><form id="edit-post-form"><textarea id="edit-post-content" class="w-full p-2 border rounded-lg" rows="5"></textarea><div class="flex justify-end space-x-4 mt-4"><button type="button" id="cancel-edit-post-btn" class="bg-gray-200 px-4 py-2 rounded-lg">Cancelar</button><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg">Salvar</button></div></form></div></div>
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-xl p-6 text-center"><h3 class="text-lg font-bold">Tem certeza?</h3><p class="text-gray-600 my-4">Esta ação não pode ser desfeita.</p><div class="flex justify-center space-x-4"><button id="cancel-delete-btn" class="bg-gray-200 px-6 py-2 rounded-lg">Cancelar</button><button id="confirm-delete-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg">Excluir</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBKFZ8Zp0e9V6pH_hM-UIITTlIEomlTDLQ",
            authDomain: "agi-v1-e4000.firebaseapp.com",
            projectId: "agi-v1-e4000",
            storageBucket: "agi-v1-e4000.appspot.com",
            messagingSenderId: "908312431193",
            appId: "1:908312431193:web:50c5aac95753327365bf48"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = { uid: null, displayName: null, photoURL: null };
        let selectedImageFile = null;
        let postsUnsubscribe = () => {};
        let eventsUnsubscribe = () => {};
        let allPosts = [];
        let allEvents = [];
        let activeChatListener = null;

        const DOM = {
            logoutBtn: document.getElementById('logout-btn'),
            userAvatar: document.getElementById('user-avatar'),
            userEmailDisplay: document.getElementById('user-email-display'),
            profileMenuBtn: document.getElementById('profile-menu-btn'),
            profileMenu: document.getElementById('profile-menu'),
            createPostForm: document.getElementById('create-post-form'),
            postContent: document.getElementById('post-content'),
            feedContainer: document.getElementById('feed-container'),
            addImageBtn: document.getElementById('add-image-btn'),
            imageUploadInput: document.getElementById('image-upload-input'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
            imagePreview: document.getElementById('image-preview'),
            removeImageBtn: document.getElementById('remove-image-btn'),
            postSubmitBtn: document.getElementById('post-submit-btn'),
            geminiIdeaBtn: document.getElementById('gemini-idea-btn'),
            usersList: document.getElementById('users-list'),
            chatModal: document.getElementById('chat-modal'),
            userListView: document.getElementById('user-list-view'),
            conversationView: document.getElementById('conversation-view'),
            floatingChatBtn: document.getElementById('floating-chat-btn'),
            closeUserListBtn: document.getElementById('close-user-list-btn'),
            closeConversationBtn: document.getElementById('close-conversation-btn'),
            backToUsersBtn: document.getElementById('back-to-users-btn'),
            searchUserInput: document.getElementById('search-user-input'),
            chatHeaderAvatar: document.getElementById('chat-header-avatar'),
            chatHeaderName: document.getElementById('chat-header-name'),
            messagesArea: document.getElementById('messages-area'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            friendsToggleBtn: document.getElementById('friends-toggle-btn'),
            friendsListNav: document.getElementById('friends-list-nav'),
            friendCount: document.getElementById('friend-count'),
            editPostModal: document.getElementById('edit-post-modal'),
            editPostForm: document.getElementById('edit-post-form'),
            editPostContent: document.getElementById('edit-post-content'),
            cancelEditPostBtn: document.getElementById('cancel-edit-post-btn'),
            deleteConfirmModal: document.getElementById('delete-confirm-modal'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
        };

        // --- LÓGICA PRINCIPAL ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                currentUser = userDoc.exists() ? { ...user, ...userDoc.data() } : user;
                DOM.userEmailDisplay.textContent = currentUser.email;
                DOM.userAvatar.src = currentUser.photoURL || `https://i.pravatar.cc/40?u=${currentUser.uid}`;
                await setDoc(userDocRef, { status: 'online' }, { merge: true });
                initializeEventListeners();
                fetchFeedItems();
            } else {
                if (currentUser && currentUser.uid) {
                    await updateDoc(doc(db, "users", currentUser.uid), { status: 'offline' });
                }
                window.location.href = './login.html';
            }
        });

        // --- INICIALIZADOR DE EVENTOS ---
        function initializeEventListeners() {
            DOM.logoutBtn.addEventListener('click', handleSignOut);
            DOM.profileMenuBtn.addEventListener('click', () => DOM.profileMenu.classList.toggle('hidden'));
            DOM.createPostForm.addEventListener('submit', handlePostSubmit);
            DOM.addImageBtn.addEventListener('click', () => alert("Funcionalidade em desenvolvimento"));
            DOM.feedContainer.addEventListener('click', handlePostActions);
            DOM.editPostForm.addEventListener('submit', handlePostEditSubmit);
            DOM.confirmDeleteBtn.addEventListener('click', handlePostDeleteConfirm);
            DOM.cancelEditPostBtn.addEventListener('click', () => DOM.editPostModal.classList.add('hidden'));
            DOM.cancelDeleteBtn.addEventListener('click', () => DOM.deleteConfirmModal.classList.add('hidden'));
        }

        // --- FUNÇÕES DE MANIPULAÇÃO DE EVENTOS ---
        async function handleSignOut() {
            if (currentUser && currentUser.uid) {
                await updateDoc(doc(db, "users", currentUser.uid), { status: 'offline' });
            }
            signOut(auth);
        }

        async function handlePostSubmit(e) {
            e.preventDefault();
            const content = DOM.postContent.value.trim();
            if (!content) return;
            DOM.postSubmitBtn.disabled = true;
            await addDoc(collection(db, "posts"), {
                authorId: currentUser.uid,
                authorDisplayName: currentUser.displayName,
                authorPhotoURL: currentUser.photoURL,
                content,
                timestamp: serverTimestamp(),
                likes: [],
                comments: [],
            });
            DOM.postContent.value = '';
            DOM.postSubmitBtn.disabled = false;
        }
        
        // --- FUNÇÕES DE DADOS (FETCH) ---
        function fetchFeedItems() {
            if (postsUnsubscribe) postsUnsubscribe();
            if (eventsUnsubscribe) eventsUnsubscribe();
            const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            postsUnsubscribe = onSnapshot(postsQuery, (snapshot) => {
                allPosts = snapshot.docs.map(doc => ({ id: doc.id, type: 'post', ...doc.data() }));
                renderFeed();
            });
            const eventsQuery = query(collection(db, "events"), orderBy("createdAt", "desc"));
            eventsUnsubscribe = onSnapshot(eventsQuery, (snapshot) => {
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, type: 'event', timestamp: doc.data().createdAt, ...doc.data() }));
                renderFeed();
            });
        }
        
        function renderFeed() {
            const feedItems = [...allPosts, ...allEvents];
            feedItems.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
            DOM.feedContainer.innerHTML = '';
            if (feedItems.length === 0) {
                DOM.feedContainer.innerHTML = '<p class="text-center text-gray-500">Nenhum post ou evento ainda.</p>';
            } else {
                feedItems.forEach(item => {
                    if (item.type === 'post') {
                        DOM.feedContainer.appendChild(createPostElement(item.id, item));
                    } else if (item.type === 'event') {
                        DOM.feedContainer.appendChild(createEventPostElement(item.id, item));
                    }
                });
            }
        }
        
        // --- FUNÇÕES DE CRIAÇÃO DE ELEMENTOS ---
        function createPostElement(postId, post) {
            const postElement = document.createElement('div');
            postElement.className = 'bg-white p-4 rounded-lg shadow-md relative feed-item';
            
            const isLiked = post.likes && post.likes.includes(currentUser.uid);
            let authorControls = '';
            if (currentUser && post.authorId === currentUser.uid) {
                authorControls = `
                    <div class="absolute top-2 right-2 flex space-x-1">
                        <button class="edit-post-btn p-2 rounded-full hover:bg-gray-100" data-post-id="${postId}" data-content="${post.content}"><svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button class="delete-post-btn p-2 rounded-full hover:bg-gray-100" data-post-id="${postId}"><svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>`;
            }
            
            postElement.innerHTML = `
                ${authorControls}
                <div class="flex items-start space-x-4">
                    <img src="${post.authorPhotoURL || `https://i.pravatar.cc/48?u=${post.authorId}`}" class="w-12 h-12 rounded-full" alt="Avatar">
                    <div>
                        <p class="font-bold">${post.authorDisplayName || 'Usuário'}</p>
                        <p class="text-xs text-gray-400">${post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString('pt-BR') : 'agora'}</p>
                    </div>
                </div>
                <p class="text-gray-700 whitespace-pre-line my-4">${post.content}</p>
                <div class="flex items-center space-x-4 border-t pt-2">
                    <button class="like-btn flex items-center space-x-2 text-gray-500 hover:text-red-500 ${isLiked ? 'like-btn-liked' : ''}" data-post-id="${postId}">
                        <svg class="w-6 h-6" fill="${isLiked ? '#ef4444' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        <span>${post.likes.length}</span>
                    </button>
                    <button class="comment-btn flex items-center space-x-2 text-gray-500 hover:text-orange-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        <span>${post.comments ? post.comments.length : 0}</span>
                    </button>
                </div>
            `;
            return postElement;
        }

        function createEventPostElement(eventId, eventData) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'bg-white p-4 rounded-lg shadow-md feed-item';
            const eventDate = new Date(`${eventData.date}T${eventData.time}`);
            const formattedDate = eventDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' });
            const formattedTime = eventDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            eventDiv.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 rounded-lg bg-orange-100 flex flex-col items-center justify-center font-bold text-orange-600">
                        <span class="text-xs">${formattedDate.split(' ')[2]}</span>
                        <span class="text-xl">${formattedDate.split(' ')[0]}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-orange-600">NOVO EVENTO</p>
                        <h3 class="font-bold text-lg text-gray-800">${eventData.name}</h3>
                        <p class="text-sm text-gray-500">${formattedTime} - ${eventData.location}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="./eventos.html" class="w-full text-center block bg-orange-500 text-white py-2 rounded-lg hover:bg-orange-600 font-semibold">Ver Detalhes do Evento</a>
                </div>
            `;
            return eventDiv;
        }

        function handlePostActions(e) {
            const likeBtn = e.target.closest('.like-btn');
            if(likeBtn) {
                const postId = likeBtn.dataset.postId;
                const postRef = doc(db, "posts", postId);
                if (likeBtn.classList.contains('like-btn-liked')) {
                    updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
                } else {
                    updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
                }
            }

            const editBtn = e.target.closest('.edit-post-btn');
            if (editBtn) {
                DOM.editPostModal.classList.remove('hidden');
                DOM.editPostContent.value = editBtn.dataset.content;
                DOM.editPostForm.dataset.postId = editBtn.dataset.postId;
            }

            const deleteBtn = e.target.closest('.delete-post-btn');
            if (deleteBtn) {
                DOM.deleteConfirmModal.classList.remove('hidden');
                DOM.confirmDeleteBtn.dataset.postId = deleteBtn.dataset.postId;
            }
        }
        
        async function handlePostEditSubmit(e) {
            e.preventDefault();
            const postId = e.target.dataset.postId;
            const newContent = DOM.editPostContent.value;
            await updateDoc(doc(db, "posts", postId), { content: newContent });
            DOM.editPostModal.classList.add('hidden');
        }
        
        async function handlePostDeleteConfirm(e) {
            const postId = e.target.dataset.postId;
            await deleteDoc(doc(db, "posts", postId));
            DOM.deleteConfirmModal.classList.add('hidden');
        }

    </script>
</body>
</html>
